---
title: "Big Data Bowl Phase II"
author: "Adam Kovar"
date: "2025-10-26"
output: html_document
---

Load in Files and Libraries
--- 
```{r Load in packages and data}
library(tidyverse)
library(ggplot2)
library(ggpmisc)

supp <- read_csv("supplementary_data.csv")
input <- read_csv("input_2023_w01.csv")
output <- read_csv("output_2023_w01.csv")
```

# Idea 1: Evaluating Change in Defensive Positioning Amongst Secondary Players to Minimize Yards After the Catch (YAC)

---
## --- 1. Create clean player info table ---
```{r Create clean player info table}  
player_details <- input %>%
  select(game_id, play_id, nfl_id, player_name, player_position, player_role) %>%
  distinct()
```
## --- 2. Create play-level direction table ---
```{r Create play-level direction table}
play_direction_table <- input %>%
  select(game_id, play_id, play_direction) %>%
  distinct()
```

## --- 3. Create the catch point ---
```{r Create catch point}
output_v2 <- output %>%
  group_by(play_id) %>%
  mutate(frame_id = frame_id + max(input$frame_id[input$play_id == unique(play_id)])) %>%
  ungroup()

combined_df <- bind_rows(input, output_v2) %>%
  arrange(game_id, play_id, nfl_id, frame_id)

combined_df$yards_gained <- supp$yards_gained[
  match(
    paste(combined_df$game_id, combined_df$play_id),
    paste(supp$game_id, supp$play_id)
  )
]

combined_df$pass_result <- supp$pass_result[
  match(
    paste(combined_df$game_id, combined_df$play_id),
    paste(supp$game_id, supp$play_id)
  )
]

combined_df <- combined_df %>%
  group_by(game_id, play_id) %>%
  arrange(nfl_id, frame_id, .by_group = TRUE) %>%  # ensure chronological order
  fill(c(player_role, player_to_predict, play_direction, absolute_yardline_number, play_direction, player_name, player_height, player_weight, player_birth_date,
         player_birth_date, player_position, player_side, num_frames_output, ball_land_x, ball_land_y), .direction = "down") %>%  # forward-fill within play
  ungroup()


combined_df <- combined_df %>%
  mutate(
    # Normalize direction of travel so yard distances are always positive downfield
    yards_to_catch = case_when(
      combined_df$play_direction == "left"  ~ combined_df$absolute_yardline_number - combined_df$x,  # moving left = smaller x values downfield
      combined_df$play_direction == "right" ~ combined_df$x - combined_df$absolute_yardline_number,  # moving right = larger x values downfield
      TRUE ~ NA_real_
    ),
    
    # Cap negative distances at 0 (if tracking noise or catch behind LOS)
    yards_to_catch = pmax(yards_to_catch, 0),
    
    # Compute YAC only for completed passes
    yards_after_catch = case_when(
      pass_result == "C"  ~ yards_gained - yards_to_catch,
      pass_result %in% c("I", "IN") ~ 0,
      TRUE ~ NA_real_
    ),
    
    # Clean up extreme or invalid values
    yards_after_catch = ifelse(yards_after_catch < 0, 0, yards_after_catch)
  )

point_of_catch <- combined_df %>%
  filter(player_role == "Targeted Receiver") %>%
  group_by(game_id, play_id) %>%
  filter(frame_id == max(frame_id)) %>%  # final frame for targeted receiver
  ungroup() %>%
  select(game_id, play_id, x_catch = x, y_catch = y)
```

## --- 4. Create yards after the catch ---
```{r Create YAC}
catch_points <- combined_df %>%
  filter(player_role == "Targeted Receiver") %>%
  group_by(game_id, play_id) %>%
  filter(frame_id == max(frame_id)) %>%  # final frame for targeted receiver
  ungroup() %>%
  select(game_id, play_id, x_catch = x)

combined_df_catch <- combined_df %>%
  left_join(catch_points, by = c("game_id", "play_id")) %>%
  mutate(
    # Calculate yards from LOS to catch point, respecting play direction
    yards_to_catch = case_when(
      play_direction == "left"  ~ absolute_yardline_number - x_catch,
      play_direction == "right" ~ x_catch - absolute_yardline_number,
      TRUE ~ NA_real_
    ),
    
    # Prevent negative yards due to behind-line catches or rounding
    yards_to_catch = pmax(yards_to_catch, 0),
    
    # Calculate Yards After Catch
    yards_after_catch = case_when(
      pass_result == "C"  ~ yards_gained - yards_to_catch,
      pass_result %in% c("I", "IN") ~ 0,
      TRUE ~ NA_real_
    ),
    
    # Clean up any invalid negative values
    yards_after_catch = ifelse(yards_after_catch < 0, 0, yards_after_catch)
  )
```

## --- 5. Looking at Yards After the Catch Opportunities from Week 1 ---
```{r Basic YAC investigation}
#Basic YAC investigation
play_group <- combined_df_catch %>%
  group_by(game_id, play_id) %>%
  summarize(
    YAC_per_play = max(yards_after_catch, na.rm = TRUE),
    .groups = "drop"
  )

in_play_group <- combined_df_catch %>%
  filter(pass_result == "C") %>%
  group_by(game_id, play_id) %>%
  summarize(
    YAC_per_play = max(yards_after_catch, na.rm = TRUE),
    .groups = "drop"
  )

yac_hist_play <- play_group %>%
  mutate(
    YAC_bin = cut(
      YAC_per_play,
      breaks = c(-Inf, 2, 5, 8, 10, Inf),
      labels = c("0–2", "3–5", "6-8", "9-10", "10+"),
      right = TRUE
    )
  ) %>%
  group_by(YAC_bin) %>%
  summarize(num_plays = n(), .groups = "drop")

ggplot(yac_hist_play, aes(x = YAC_bin, y = num_plays)) +
  geom_col(fill = "#2C7BB6", width = 0.6) +
  geom_text(aes(label = num_plays), vjust = -0.5, size = 5) +
  labs(
    title = "Yards After Catch (YAC) for Every Pass in Week 1",
    x = "Yards After Catch (yards)",
    y = "Number of Plays"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  ylim(0, max(yac_hist_play$num_plays) * 1.1)  # Add space for labels

yac_hist_in_play <- in_play_group %>%
  mutate(
    YAC_bin = cut(
      YAC_per_play,
      breaks = c(-Inf, 2, 5, 8, 10, Inf),
      labels = c("0–2", "3–5", "6-8", "9-10", "10+"),
      right = TRUE
    )
  ) %>%
  group_by(YAC_bin) %>%
  summarize(num_plays = n(), .groups = "drop")

ggplot(yac_hist_in_play, aes(x = YAC_bin, y = num_plays)) +
  geom_col(fill = "#2C7BB6", width = 0.6) +
  geom_text(aes(label = num_plays), vjust = -0.5, size = 5) +
  labs(
    title = "Yards After Catch (YAC) per Completed Pass in Week 1",
    x = "Yards After Catch (yards)",
    y = "Number of Plays"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  ylim(0, max(yac_hist_in_play$num_plays) * 1.1)  # Add space for labels

```


## --- 6. Building out distance to the catch point ---
```{r Building out distance to football}
#Building out distance to football

combined_df_def2 <- output %>%
  left_join(point_of_catch, by = c("game_id", "play_id")) %>%
  
  mutate(
    # Euclidean distance to catch point in each frame
    dist_to_catch = sqrt((x - x_catch)^2 + (y - y_catch)^2)
  ) %>%
  
  group_by(game_id, play_id, nfl_id) %>%
  summarize(
    # Start distance: first frame in the play for that player
    dist_start = dist_to_catch[frame_id == min(frame_id)][1],
    
    # End distance: last frame in the play for that player
    dist_end = dist_to_catch[frame_id == max(frame_id)][1],
    
    # Change in distance toward catch point (positive = moved closer)
    change_in_dist = dist_start - dist_end,
    
    .groups = "drop"
  )
```

## --- 7. Isolating defensive players ---
```{r Isolating defensive players}

player_roles <- input %>%
  select(game_id, play_id, nfl_id, player_side, player_role, player_name) %>%
  distinct()

player_roles <- player_roles %>%
  filter(player_role == "Defensive Coverage")

combined_df_def2 <- combined_df_def2 %>%
  filter(nfl_id %in% player_roles$nfl_id)
```

## --- 8. Adding in context to plays ---
```{r Adding in context to plays}

combined_df_def2 <- combined_df_def2 %>%
  left_join(
    input %>%
      select(
        game_id, play_id, player_to_predict, nfl_id, player_name,
        player_height, player_weight, player_birth_date,
        player_position, player_side, player_role
      ) %>%
      distinct(),  # removes duplicates efficiently
    by = c("game_id", "play_id", "nfl_id")
  )

combined_df_def2 <- combined_df_def2 %>%
  left_join(
    supp %>%
      select(game_id, play_id, pass_result, team_coverage_man_zone, team_coverage_type) %>%
      distinct(),  # removes duplicates efficiently
    by = c("game_id", "play_id")
  )

combined_df_def2 <- combined_df_def2 %>%
  left_join(
    combined_df_catch %>%
      select(game_id, play_id, yards_after_catch) %>%
      distinct(),  # removes duplicates efficiently
    by = c("game_id", "play_id")
  )
```


## --- 9. Determine defender position at catch point ---
```{r Determine defender position at catch point}
defender_relative_pos <- output %>%
  # Add catch location
  left_join(
    point_of_catch %>%
      select(game_id, play_id, x_catch, y_catch),
    by = c("game_id", "play_id")
  ) %>%
  
  # Add play direction
  left_join(
    play_direction_table,
    by = c("game_id", "play_id")
  ) %>%
  
  # Add player role
  left_join(
    player_details %>%
      select(game_id, play_id, nfl_id, player_role),
    by = c("game_id", "play_id", "nfl_id")
  ) %>%
  
  # Filter for defenders only
  filter(player_role == "Defensive Coverage") %>%
  
  # Keep only final frame per defender per play
  group_by(game_id, play_id, nfl_id) %>%
  filter(frame_id == max(frame_id, na.rm = TRUE)) %>%
  ungroup() %>%
  
  # Classify defender position relative to catch
  mutate(
    relative_position = case_when(
      play_direction == "right" & x > x_catch ~ "in front",
      play_direction == "right" & x < x_catch ~ "behind",
      play_direction == "left"  & x < x_catch ~ "in front",
      play_direction == "left"  & x > x_catch ~ "behind",
      TRUE ~ "unknown"
    ),
    dist_to_catch = sqrt((x - x_catch)^2 + (y - y_catch)^2),
    downfield_diff = abs(x - x_catch)
  ) %>%
  
  # --- 4. Add defender details ---
  left_join(
    player_details %>%
      rename(
        defender_nfl_id = nfl_id,
        defender_name = player_name,
        defender_position = player_position,
        defender_role = player_role
      ),
    by = c("game_id", "play_id", "nfl_id" = "defender_nfl_id")
  ) %>%
  
  select(
    game_id, play_id,
    defender_name, defender_position, defender_role, nfl_id,
    play_direction, relative_position, dist_to_catch, downfield_diff
  )

defender_relative_pos <- defender_relative_pos %>%
  left_join(combined_df_def2, by = c("game_id", "play_id", "nfl_id")) %>%
  select(game_id, play_id, nfl_id, defender_name,  defender_position, defender_role, play_direction, 
         dist_start, dist_to_catch, change_in_dist, downfield_diff, relative_position, yards_after_catch,
         pass_result, team_coverage_man_zone, team_coverage_type)
```

## --- 10. Filter for completed passes ---
```{r Filter for completed passes}
completed_passes_def <- defender_relative_pos %>%
  filter(pass_result == "C" &
           relative_position == "in front" &
           defender_position %in% c("CB", "SS", "FS"))

defender_relative_pos <- defender_relative_pos %>%
  mutate(
    in_position_tackle_at_catch = case_when(
      pass_result == "C" &
        dist_to_catch <= 1 &
        relative_position == "in front" ~ "Yes",
      TRUE ~ "Not a completion/Not in position"
    )
  )

completed_passes_def <- defender_relative_pos %>%
  group_by(defender_position) %>%
  filter(in_position_tackle_at_catch == "Yes") %>%
  summarise(YAC_allowed = mean(yards_after_catch),
            Distance_covered = mean(change_in_dist))
```

## --- 11. Prepare the visualization of defensive positions  ---
```{r Prepare Visualization}
# Create a label column with formatted values
completed_passes_def <- completed_passes_def %>%
  mutate(
    label = paste0(defender_position, ": ",
                   round(Distance_covered, 2), ", ",
                   round(YAC_allowed, 2))
  )


# Create label column
completed_passes_def <- completed_passes_def %>%
  mutate(
    label = paste0(defender_position, ": ",
                   round(Distance_covered, 2), ", ",
                   round(YAC_allowed, 2))
  )

ggplot(completed_passes_def, aes(x = Distance_covered, y = YAC_allowed)) +
  geom_point(color = "#1f78b4", size = 4) +
  geom_text(
    aes(label = label),
    vjust = -0.8,
    fontface = "bold",
    size = 3.5
  ) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed", color = "gray40") +
  scale_x_continuous(
    limits = c(min(completed_passes_def$Distance_covered) - 0.5,
               max(completed_passes_def$Distance_covered) + 0.5)
  ) +
  scale_y_continuous(
    limits = c(min(completed_passes_def$YAC_allowed) - 0.3,
               max(completed_passes_def$YAC_allowed) + 0.3)
  ) +
  labs(
    title = "Defensive Efficiency: YAC Allowed vs Distance Covered to Make a Tackle",
    x = "Average Distance Covered (Yards)",
    y = "Average YAC Allowed (Yards)"
  ) +
  theme_minimal(base_size = 9) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text = element_text(color = "gray20"),
    plot.margin = margin(20, 20, 20, 20)
  )
```

# Idea 2: How does Coverage Success, the defense’s ability to limit receiver separation with the ball in the air, affect game outcomes (completions/incompletions, interceptions, win probability)?

## --- 1. Identifying player roles  ---
```{r tag play roles}
player_roles <- input %>%
  select(game_id, play_id, nfl_id, player_side, player_role, player_name) %>%
  distinct()

out_tagged <- output %>%
  left_join(player_roles, by = c("game_id", "play_id", "nfl_id"))
```

## --- 2. Get all receiver trajectories ---
```{r receiver trajectories}
receiver_traj <- out_tagged %>%
  filter(player_side == "Offense", player_role %in% c("Receiver", "Targeted Receiver")) %>%
  select(game_id, play_id, frame_id, nfl_id, x, y) %>%
  rename(rec_nfl_id = nfl_id, rec_x = x, rec_y = y)
```

## --- 3. Get all defender trajectories ---
```{r defender trajectories}
defenders_traj <- out_tagged %>%
  filter(player_side == "Defense") %>%
  select(game_id, play_id, frame_id, nfl_id, x, y) %>%
  rename(def_nfl_id = nfl_id, def_x = x, def_y = y)
```

## --- 4. Join all receiver-defender pairs per frame ---
```{r creating receiver - defender pairs}
pairwise <- receiver_traj %>%
  left_join(defenders_traj, by = c("game_id", "play_id", "frame_id")) %>%
  mutate(
    dist_to_receiver = sqrt((def_x - rec_x)^2 + (def_y - rec_y)^2)
  )
```

## --- 5. Keep closest defender per receiver per frame, even if none exist ---
```{r filtering out further pairings}
receiver_defender_pairs <- pairwise %>%
  group_by(game_id, play_id, frame_id, rec_nfl_id) %>%
  slice_min(order_by = dist_to_receiver, with_ties = FALSE) %>%
  ungroup()
```

# --- 6. Extract game-level team info with coverage ---
```{r game info from supplementary data}
game_teams <- supp %>%
  select(game_id, play_id, possession_team, home_team_abbr, visitor_team_abbr,
         team_coverage_man_zone, team_coverage_type) %>%
  distinct()
```

# --- 7. Tag player roles and join game context ---
```{r bring in player roles}
player_roles <- input %>%
  select(game_id, play_id, nfl_id, player_name, player_position, player_side, player_role) %>%
  distinct() %>%
  left_join(game_teams, by = c("game_id", "play_id"))
```

# --- 8. Player team assignments ---
```{r build out team assignments}
player_info <- player_roles %>%
  mutate(
    team = case_when(
      player_side == "Offense" & possession_team == home_team_abbr ~ home_team_abbr,
      player_side == "Offense" & possession_team == visitor_team_abbr ~ visitor_team_abbr,
      player_side == "Defense" & possession_team == home_team_abbr ~ visitor_team_abbr,
      player_side == "Defense" & possession_team == visitor_team_abbr ~ home_team_abbr,
      TRUE ~ NA_character_
    )
  ) %>%
  select(game_id, play_id, nfl_id, player_name, player_position, team) %>%
  distinct()
```

# --- 9. Join receiver and defender info ---
```{r join receiver and defender info}
receiver_defender_pairs <- receiver_defender_pairs %>%
  left_join(player_info, by = c("game_id", "play_id", "rec_nfl_id" = "nfl_id")) %>%
  rename(
    receiver_name = player_name,
    receiver_position = player_position,
    receiver_team = team
  ) %>%
  left_join(player_info, by = c("game_id", "play_id", "def_nfl_id" = "nfl_id")) %>%
  rename(
    defender_name = player_name,
    defender_position = player_position,
    defender_team = team
  )
```

# --- 10. Join coverage info at the end ---
```{r merging coverage info}
coverage_info <- game_teams %>%
  select(game_id, play_id, team_coverage_man_zone, team_coverage_type) %>%
  distinct()

receiver_defender_pairs <- receiver_defender_pairs %>%
  left_join(coverage_info, by = c("game_id", "play_id"))
```

# --- 11. Identifying average separation by coverage type ---
```{r separation by coverage type}
man_cov <- receiver_defender_pairs %>%
  filter(team_coverage_man_zone == "MAN_COVERAGE")

zone_cov <- receiver_defender_pairs %>%
  filter(team_coverage_man_zone == "ZONE_COVERAGE")

avg_man_separation <- man_cov %>%
  summarise(avg_separation = mean(dist_to_receiver, na.rm = TRUE)) %>%
  pull(avg_separation)

std_dev_man_separation <- man_cov %>%
  summarise(sd_separation = sd(dist_to_receiver, na.rm = TRUE)) %>%
  pull(sd_separation)

avg_zone_separation <- zone_cov %>%
  summarise(avg_separation = mean(dist_to_receiver, na.rm = TRUE)) %>%
  pull(avg_separation)

std_dev_zone_separation <- zone_cov %>%
  summarise(sd_separation = sd(dist_to_receiver, na.rm = TRUE)) %>%
  pull(sd_separation)

avg_man_separation 
avg_zone_separation
```

# --- 12. Merging win probability and pass result ---
```{r win prob and pass result}
win_prob_info <- supp %>%
  select(game_id, play_id, home_team_abbr, visitor_team_abbr,
         home_team_win_probability_added,
         visitor_team_win_probility_added) %>%
  distinct()

receiver_defender_pairs <- receiver_defender_pairs %>%
  left_join(win_prob_info, by = c("game_id", "play_id"))

pass_info <- supp %>%
  select(game_id, play_id, pass_result) %>%
  distinct()

receiver_defender_pairs <- receiver_defender_pairs %>%
  left_join(pass_info, by = c("game_id", "play_id"))
```

# --- 13. Creating variable for Coverage Success: "good_coverage" ---
```{r creating good_coverage}
receiver_defender_pairs <- receiver_defender_pairs %>%
  mutate(
    good_coverage = case_when(
      team_coverage_man_zone == "MAN_COVERAGE" & dist_to_receiver <= avg_man_separation ~ 1,
      team_coverage_man_zone == "ZONE_COVERAGE" & dist_to_receiver <= avg_zone_separation ~ 1,
      TRUE ~ 0
    )
  )
```

# --- 14. Evaluating Coverage Success as a percent of plays ---
```{r creating coverage success}
completions <- receiver_defender_pairs %>%
  filter(pass_result == "C")

incompletions <- receiver_defender_pairs %>%
  filter(pass_result == "I")

interceptions <- receiver_defender_pairs %>%
  filter(pass_result == "IN")

completion_coverage_percentage <- completions %>%
  summarise(cov_perc = sum(good_coverage, na.rm = TRUE) / n()) %>%
  pull(cov_perc)

incompletion_coverage_percentage <- incompletions %>%
  summarise(cov_perc = sum(good_coverage, na.rm = TRUE) / n()) %>%
  pull(cov_perc)

interception_coverage_percentage <- interceptions %>%
  summarise(cov_perc = sum(good_coverage, na.rm = TRUE) / n()) %>%
  pull(cov_perc)

completions_last_frames <- completions %>%
  group_by(game_id, play_id) %>%
  filter(frame_id == max(frame_id, na.rm = TRUE)) %>%
  ungroup()

completions_final_frame_pct <- completions_last_frames %>%
  summarise(
    coverage_success = sum(good_coverage, na.rm = TRUE) / n()
  ) %>%
  pull(coverage_success)

incompletions_last_frames <- incompletions %>%
  group_by(game_id, play_id) %>%
  filter(frame_id == max(frame_id, na.rm = TRUE)) %>%
  ungroup()

incompletions_final_frame_pct <- incompletions_last_frames %>%
  summarise(
    coverage_success = sum(good_coverage, na.rm = TRUE) / n()
  ) %>%
  pull(coverage_success)

interceptions_last_frames <- interceptions %>%
  group_by(game_id, play_id) %>%
  filter(frame_id == max(frame_id, na.rm = TRUE)) %>%
  ungroup()

interceptions_final_frame_pct <- interceptions_last_frames %>%
  summarise(
    coverage_success = sum(good_coverage, na.rm = TRUE) / n()
  ) %>%
  pull(coverage_success)
```

# --- 15. Coverage Success per situation ---

## Completed Passes:

### Percent of frames while the ball is in the air that the receiver was covered
```{r}
completion_coverage_percentage * 100
```


### Percent of routes the receiver was covered at the catch point
```{r}
completions_final_frame_pct * 100
```

## Incomplete Passes:

### Percent of frames while the ball is in the air that the receiver was covered
```{r}
incompletion_coverage_percentage * 100
```


### Percent of routes the receiver was covered at the catch point
```{r}
incompletions_final_frame_pct * 100
```

## Intercepted Passes:

### Percent of frames while the ball is in the air that the receiver was covered
```{r}
interception_coverage_percentage * 100
```


### Percent of routes the receiver was covered at the catch point
```{r}
interceptions_final_frame_pct * 100
```

# --- 16. Incorporating win probability ---
```{r win probab}
coverage_summary <- receiver_defender_pairs %>%
  group_by(game_id, play_id, defender_team) %>%
  summarise(
    coverage_success_pct = mean(good_coverage, na.rm = TRUE),
    .groups = "drop"
  )
wp_info <- supp %>%
  select(game_id, play_id,
         home_team_abbr, visitor_team_abbr,
         home_team_win_probability_added,
         visitor_team_win_probility_added)

coverage_summary <- coverage_summary %>%
  left_join(wp_info, by = c("game_id", "play_id"))

coverage_summary <- coverage_summary %>%
  mutate(
    def_wp_added = case_when(
      defender_team == home_team_abbr ~ home_team_win_probability_added,
      defender_team == visitor_team_abbr ~ visitor_team_win_probility_added,
      TRUE ~ NA_real_
    )
  )

coverage_summary %>%
  filter(!is.na(coverage_success_pct), !is.na(def_wp_added)) %>%
  mutate(
    coverage_pct = coverage_success_pct * 100
  ) %>%
  filter(!is.na(coverage_pct)) %>%
  mutate(
    bin = cut(coverage_pct, breaks = seq(0, 100, by = 10), include.lowest = TRUE, right = FALSE)
  ) %>%
  group_by(bin) %>%
  summarise(
    avg_wp = mean(def_wp_added, na.rm = TRUE),
    count = n()
  ) %>%
  mutate(
    avg_wp_pct = avg_wp * 100,
    bin_label = as.character(bin),
    label = paste0("Plays: ", count, "\nWP: ", round(avg_wp_pct, 2), "%")
  ) %>%
  ggplot(aes(x = bin_label, y = avg_wp_pct)) +
  geom_col(fill = "#3498DB") +
  geom_text(aes(label = label), vjust = -0.5, size = 3.5, color = "black", fontface = "bold", lineheight = 0.9) +
  scale_x_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  labs(
    title = "Average Win Probability Added by Coverage Success Bin",
    subtitle = "Labels show number of plays and average WP added per bin",
    x = "Coverage Success Bin (%)",
    y = "Avg Win Probability Added (%)"
  ) +
  coord_cartesian(ylim = c(-2, 2)) +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

